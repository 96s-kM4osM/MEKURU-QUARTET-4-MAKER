<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEKURU QUARTET 4 MAKER</title>
    <style>
        :root {
            --primary-cyan: #00C0FF;
            --primary-magenta: #FF80FF;
            --bg-light: #f8fafc;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --gradient-primary: linear-gradient(135deg, #00C0FF 0%, #FF80FF 100%);
            --gradient-card: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            padding-left: 80px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 20px 20px 0;
        }

        /* Vertical Title */
        .vertical-title {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, var(--primary-cyan) 0%, var(--primary-magenta) 100%);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 3.2rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: white;
            z-index: 1000;
            pointer-events: none;
        }

        /* Header */
        .header {
            position: relative;
            margin-bottom: 20px;
        }

        /* Tab Navigation */
        .tab-nav {
            position: absolute;
            top: 0px;
            right: 20px;
            display: flex;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: var(--gradient-primary);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            color: var(--primary-cyan);
            background: rgba(0, 192, 255, 0.05);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Grid */
        .content-grid {
            display: grid;
            grid-template-columns: minmax(600px, 1fr) 500px;
            gap: 30px;
            align-items: stretch;
            width: 100%;
            margin-top: 65px;
        }

        .section-card {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px var(--shadow);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .section-card form {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .section-card .card-preview {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 18px;
        }

        .form-group-inline {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
        }

        .form-group-inline .form-label {
            margin-bottom: 0;
            min-width: 100px;
            flex-shrink: 0;
        }

        .form-group-inline .form-input,
        .form-group-inline .form-select {
            flex: 1;
            min-width: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 14px;
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-dark);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 0 3px rgba(0, 192, 255, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        /* File Upload */
        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 18px;
            background: rgba(0, 192, 255, 0.05);
            border: 2px dashed var(--primary-cyan);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-dark);
        }

        .file-upload-label:hover {
            background: rgba(0, 192, 255, 0.1);
            transform: translateY(-1px);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 192, 255, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-full {
            width: 100%;
            margin-top: 20px;
        }

        /* Calculator Specific */
        .calc-input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            align-content: start;
            flex: 0 0 auto;
        }

        .calc-output {
            background: rgba(0, 192, 255, 0.05);
            border: 1px solid rgba(0, 192, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .output-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .output-item {
            text-align: center;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .output-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .output-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-cyan);
        }

        /* Card Preview */
        .card-preview {
            text-align: center;
        }

        .card-preview svg {
            width: 100%;
            max-width: 869px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 20px 50px var(--shadow);
            border: 1px solid var(--border);
        }

        .card-preview-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            min-height: 500px;
            max-width: 100%;
        }

        /* Radar Chart */
        .chart-container {
            margin-top: 20px;
            height: 360px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            border-radius: 15px;
            border: 1px solid var(--border);
        }

        /* Error Messages */
        .error {
            color: #ef4444;
            font-size: 0.95rem;
            margin-top: 8px;
            display: none;
        }

        .total-stats {
            text-align: center;
            padding: 20px;
            background: rgba(255, 128, 255, 0.05);
            border: 1px solid rgba(255, 128, 255, 0.2);
            border-radius: 12px;
            margin-top: 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .stats-grid,
            .calc-input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                padding-left: 60px;
            }
            
            .container {
                padding: 15px 10px 15px 0;
            }
            
            .vertical-title {
                width: 60px;
                font-size: 1rem;
                letter-spacing: 1px;
            }
            
            .tab-nav {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 15px;
            }
            
            .stats-grid,
            .calc-input-grid {
                grid-template-columns: 1fr;
            }
            
            .output-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .section-card {
                padding: 20px;
                max-width: none;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-group-inline .form-label {
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="vertical-title">MEKURU QUARTET 4 MAKER</div>
    
    <div class="container">
        <div class="header">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('card-maker')">カードメーカー</button>
                <button class="tab-btn" onclick="switchTab('status-calc')">ステータス計算機</button>
            </div>
        </div>

        <!-- Card Maker Tab -->
        <div id="card-maker" class="tab-content active">
            <div class="content-grid">
                <div class="section-card">
                    <form id="cardForm">
                        <div class="form-group-inline">
                            <label class="form-label" for="characterName">キャラクター名</label>
                            <input type="text" id="characterName" class="form-input" placeholder="キャラクター名を入力">
                        </div>

                        <div class="form-row">
                            <div class="form-group-inline">
                                <label class="form-label" for="attribute">属性</label>
                                <select id="attribute" class="form-select">
                                    <option value="">選択</option>
                                    <option value="fire">炎</option>
                                    <option value="grass">草</option>
                                    <option value="rock">岩</option>
                                    <option value="water">水</option>
                                    <option value="sound">音</option>
                                </select>
                            </div>

                            <div class="form-group-inline">
                                <label class="form-label" for="characterClass">クラス</label>
                                <select id="characterClass" class="form-select">
                                    <option value="">選択</option>
                                    <option value="attacker">アタッカー</option>
                                    <option value="tank">タンク</option>
                                    <option value="buffer">バッファー</option>
                                    <option value="debuffer">デバッファー</option>
                                    <option value="healer">ヒーラー</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group-inline">
                            <label class="form-label" for="skill1">スキル名1</label>
                            <input type="text" id="skill1" class="form-input" placeholder="スキル名を入力">
                        </div>

                        <div class="form-group-inline">
                            <label class="form-label" for="skill2">スキル名2</label>
                            <input type="text" id="skill2" class="form-input" placeholder="スキル名を入力（必要に応じて）">
                        </div>

                        <div class="form-group">
                            <label class="form-label">キャラクター画像</label>
                            <div class="file-upload">
                                <input type="file" id="characterImage" accept="image/*">
                                <label for="characterImage" class="file-upload-label">
                                    📁 画像ファイルを選択
                                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 5px;">
                                        推奨サイズ: 530×433px
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ステータス</label>
                            <div class="stats-grid">
                                <div>
                                    <label class="form-label" for="attack">攻撃</label>
                                    <input type="number" id="attack" class="form-input" min="1" max="119" value="20">
                                </div>
                                <div>
                                    <label class="form-label" for="defense">防御</label>
                                    <input type="number" id="defense" class="form-input" min="1" max="119" value="20">
                                </div>
                                <div>
                                    <label class="form-label" for="magic">魔法</label>
                                    <input type="number" id="magic" class="form-input" min="1" max="119" value="20">
                                </div>
                                <div>
                                    <label class="form-label" for="magicDef">魔防</label>
                                    <input type="number" id="magicDef" class="form-input" min="1" max="119" value="20">
                                </div>
                                <div>
                                    <label class="form-label" for="addition">加算</label>
                                    <input type="number" id="addition" class="form-input" min="1" max="119" value="20">
                                </div>
                                <div>
                                    <label class="form-label" for="attention">注目</label>
                                    <input type="number" id="attention" class="form-input" min="1" max="119" value="20">
                                </div>
                            </div>
                            <div class="total-stats">
                                合計: <span id="statsTotal">120</span> / 126
                            </div>
                            <div class="error" id="statsError">ステータスの合計が114～126の範囲内になるように設定してください</div>
                        </div>

                        <button type="button" class="btn btn-full" onclick="openStatusCalculator()">
                            📊 ステータス計算機を使用
                        </button>
                    </form>
                </div>

                <div class="section-card">
                    <div class="card-preview">
                        <div class="card-preview-container">
                            <div id="cardPreview"></div>
                        </div>
                        <button class="btn btn-full" id="exportButton">🎴 カードをPNGで保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Calculator Tab -->
        <div id="status-calc" class="tab-content">
            <div class="content-grid">
                <div class="section-card">
                    <div class="calc-input-grid">
                        <div class="form-group">
                            <label class="form-label" for="input-s">S値</label>
                            <input type="number" id="input-s" class="form-input" placeholder="数値を入力" min="0">
                            <div class="error" id="error-s"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="input-h1">H値1</label>
                            <input type="number" id="input-h1" class="form-input" placeholder="数値を入力" min="0">
                            <div class="error" id="error-h1"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="input-e">E値</label>
                            <input type="number" id="input-e" class="form-input" placeholder="数値を入力" min="0">
                            <div class="error" id="error-e"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="input-r">R値</label>
                            <input type="number" id="input-r" class="form-input" placeholder="数値を入力" min="0">
                            <div class="error" id="error-r"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="input-l">L値</label>
                            <input type="number" id="input-l" class="form-input" placeholder="数値を入力" min="0">
                            <div class="error" id="error-l"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="input-h2">H値2</label>
                            <input type="number" id="input-h2" class="form-input" placeholder="数値を入力" min="0">
                            <div class="error" id="error-h2"></div>
                        </div>
                    </div>
                    <button class="btn btn-full" onclick="calculateStats()">📈 計算実行</button>
                    <button class="btn btn-full" onclick="applyToCardMaker()" id="applyButton" style="display: none; margin-bottom: 20px;">🎴 カードメーカーに適用</button>
                </div>

                <div class="section-card">
                    <div class="calc-output">
                        <div class="output-grid">
                            <div class="output-item">
                                <div class="output-label">攻撃</div>
                                <div class="output-value" id="output-attack">-</div>
                            </div>
                            <div class="output-item">
                                <div class="output-label">防御</div>
                                <div class="output-value" id="output-defense">-</div>
                            </div>
                            <div class="output-item">
                                <div class="output-label">魔法</div>
                                <div class="output-value" id="output-magic">-</div>
                            </div>
                            <div class="output-item">
                                <div class="output-label">魔防</div>
                                <div class="output-value" id="output-magdef">-</div>
                            </div>
                            <div class="output-item">
                                <div class="output-label">加算</div>
                                <div class="output-value" id="output-add">-</div>
                            </div>
                            <div class="output-item">
                                <div class="output-label">注目</div>
                                <div class="output-value" id="output-focus">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="radarChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script>
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Card maker functionality
        const attributeColors = {
            fire: {
                primary: '#D15647',
                secondary: '#FFB4AB',
                background: '#7C1D11',
                inner: '#8F2414',
                frame: '#A32B1A'
            },
            grass: {
                primary: '#3DA671',
                secondary: '#8FD7B1',
                background: '#1B5737',
                inner: '#246444',
                frame: '#2D7150'
            },
            rock: {
                primary: '#D1902E',
                secondary: '#FFD4A1',
                background: '#7C4E0A',
                inner: '#8F5B0C',
                frame: '#A2680E'
            },
            water: {
                primary: '#3D97B1',
                secondary: '#9FD5E9',
                background: '#0B4F63',
                inner: '#115C72',
                frame: '#176981'
            },
            sound: {
                primary: '#888888',
                secondary: '#CECECE',
                background: '#424242',
                inner: '#555555',
                frame: '#666666'
            }
        };

        const classNameMap = {
            'attacker': 'アタッカー',
            'tank': 'タンク',
            'buffer': 'バッファー',
            'debuffer': 'デバッファー',
            'healer': 'ヒーラー'
        };

        const classDescriptions = {
            attacker: {
                cost1: "1コスト：",
                effect1: "攻撃に応じた通常ダメージを敵単体に与える",
                cost2: "3コスト：",
                effect2: "魔法に応じた属性ダメージを敵単体に与える"
            },
            tank: {
                cost1: "3コスト：",
                effect1: "自身の防御／魔防／注目を加算値分上昇",
                cost2: "パッシブ：",
                effect2: "防御／魔防／注目を20上昇（ラウンド開始直後1ターン目のみ）"
            },
            buffer: {
                cost1: "3コスト：",
                effect1: "対象1体の任意のステータス1つを自身の同ステータス値分上昇",
                cost2: "",
                effect2: ""
            },
            debuffer: {
                cost1: "3コスト：",
                effect1: "対象1体の任意のステータス1つを自身の同ステータス値分低下",
                cost2: "",
                effect2: ""
            },
            healer: {
                cost1: "4コスト：",
                effect1: "味方1体のdBを魔法+加算値分回復",
                cost2: "",
                effect2: ""
            }
        };

        let imageDataUrl = null;
        let radarChart = null;
        let calculatedStats = null;

        // Form validation and updates
        function updateStatsTotal() {
            const stats = ['attack', 'defense', 'magic', 'magicDef', 'addition', 'attention']
                .map(id => parseInt(document.getElementById(id).value) || 0);
            const sum = stats.reduce((a, b) => a + b, 0);
            document.getElementById('statsTotal').textContent = sum;
            return sum;
        }

        function validateStats() {
            const sum = updateStatsTotal();
            const errorElement = document.getElementById('statsError');
            
            if (sum < 114 || sum > 126) {
                errorElement.style.display = 'block';
                return false;
            }
            errorElement.style.display = 'none';
            return true;
        }

        // Image handling
        document.getElementById('characterImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageDataUrl = e.target.result;
                    updateCard();
                }
                reader.readAsDataURL(file);
            }
        });

        // Card update functionality
        function updateCard() {
            validateStats();

            const classType = document.getElementById('characterClass').value;
            const showSkill2 = classType === 'tank' || classType === 'attacker';

            const formData = {
                name: document.getElementById('characterName').value || 'キャラクター名',
                attribute: document.getElementById('attribute').value,
                className: classNameMap[document.getElementById('characterClass').value] || 'クラス名',
                skill1: document.getElementById('skill1').value || 'スキル名1',
                skill2: document.getElementById('skill2').value || 'スキル名2',
                stats: {
                    attack: document.getElementById('attack').value || 20,
                    defense: document.getElementById('defense').value || 20,
                    magic: document.getElementById('magic').value || 20,
                    magicDef: document.getElementById('magicDef').value || 20,
                    addition: document.getElementById('addition').value || 20,
                    attention: document.getElementById('attention').value || 20
                },
                colors: attributeColors[document.getElementById('attribute').value] || attributeColors.fire,
                description: classDescriptions[document.getElementById('characterClass').value] || classDescriptions.attacker
            };

            // SVGのサイズを適切に設定
            const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 869 1227" style="width: 460; height: auto;">
                <defs>
                    <linearGradient id="cardGradient${Date.now()}" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:${formData.colors.background}"/>
                        <stop offset="100%" style="stop-color:${formData.colors.inner}"/>
                    </linearGradient>
                </defs>
                <rect width="869" height="1227" rx="40" ry="40" fill="url(#cardGradient${Date.now()})"/>
                <rect x="20" y="20" width="829" height="1187" rx="35" ry="35" fill="${formData.colors.inner}"/>
                
                <!-- 属性アイコン -->
                <circle cx="100" cy="100" r="60" fill="${formData.colors.frame}" stroke="${formData.colors.primary}" stroke-width="3"/>
                
                <rect x="200" y="60" width="600" height="80" rx="10" ry="10" fill="${formData.colors.frame}"/>
                <text x="230" y="115" fill="white" font-family="Arial, sans-serif" font-size="48">${formData.name}</text>
                
                <rect x="60" y="180" width="749" height="580" rx="20" ry="20" fill="${formData.colors.frame}"/>
                ${imageDataUrl ? `
                    <image x="60" y="180" width="749" height="580" href="${imageDataUrl}" preserveAspectRatio="xMidYMid slice"/>
                ` : `
                    <rect x="60" y="180" width="749" height="580" rx="20" ry="20" fill="#333" stroke="${formData.colors.primary}" stroke-width="2" stroke-dasharray="10,5"/>
                    <text x="434" y="470" fill="${formData.colors.primary}" font-family="Arial, sans-serif" font-size="32" text-anchor="middle">📁 画像をアップロード</text>
                    <text x="434" y="510" fill="#888" font-family="Arial, sans-serif" font-size="24" text-anchor="middle">推奨: 530×433px</text>
                `}
                
                <rect x="60" y="780" width="749" height="100" rx="10" ry="10" fill="${formData.colors.frame}"/>
                <text x="90" y="845" fill="${formData.colors.primary}" font-family="Arial, sans-serif" font-size="40">${formData.className}</text>
                
                <g transform="translate(60, 900)">
                    <rect x="0" y="0" width="230" height="60" fill="${formData.colors.frame}"/>
                    <text x="20" y="40" fill="white" font-family="Arial, sans-serif" font-size="28">攻撃: ${formData.stats.attack}</text>
                    
                    <rect x="0" y="70" width="230" height="60" fill="${formData.colors.frame}"/>
                    <text x="20" y="110" fill="white" font-family="Arial, sans-serif" font-size="28">防御: ${formData.stats.defense}</text>
                    
                    <rect x="260" y="0" width="230" height="60" fill="${formData.colors.frame}"/>
                    <text x="280" y="40" fill="white" font-family="Arial, sans-serif" font-size="28">魔法: ${formData.stats.magic}</text>
                    
                    <rect x="260" y="70" width="230" height="60" fill="${formData.colors.frame}"/>
                    <text x="280" y="110" fill="white" font-family="Arial, sans-serif" font-size="28">魔防: ${formData.stats.magicDef}</text>
                    
                    <rect x="520" y="0" width="230" height="60" fill="${formData.colors.frame}"/>
                    <text x="540" y="40" fill="white" font-family="Arial, sans-serif" font-size="28">加算: ${formData.stats.addition}</text>
                    
                    <rect x="520" y="70" width="230" height="60" fill="${formData.colors.frame}"/>
                    <text x="540" y="110" fill="white" font-family="Arial, sans-serif" font-size="28">注目: ${formData.stats.attention}</text>
                </g>
                
                <rect x="60" y="1050" width="749" height="140" rx="10" ry="10" fill="${formData.colors.frame}"/>
                <text x="80" y="1085" fill="white" font-family="Arial, sans-serif">
                    <tspan x="80" dy="0" font-size="26" font-weight="bold">${formData.description.cost1}${formData.skill1}</tspan>
                    <tspan x="80" dy="30" font-size="22">${formData.description.effect1}</tspan>
                    ${showSkill2 ? `
                    <tspan x="80" dy="30" font-size="26" font-weight="bold">${formData.description.cost2}${formData.skill2}</tspan>
                    <tspan x="80" dy="30" font-size="22">${formData.description.effect2}</tspan>
                    ` : ''}
                </text>
            </svg>`;
            
            const previewElement = document.getElementById('cardPreview');
            if (previewElement) {
                previewElement.innerHTML = svg;
                console.log('SVG content length:', svg.length);
                console.log('Preview element innerHTML set');
                
                // SVGが実際に追加されたか確認
                const svgElement = previewElement.querySelector('svg');
                if (svgElement) {
                    console.log('SVG element found in DOM');
                } else {
                    console.error('SVG element not found in DOM after setting innerHTML');
                }
            } else {
                console.error('cardPreview element not found');
            }
        }

        // Export functionality
        document.getElementById('exportButton').addEventListener('click', function() {
            const svg = document.querySelector('#cardPreview svg');
            if (!svg) {
                alert('カードプレビューが生成されていません');
                return;
            }
            
            const serializer = new XMLSerializer();
            const svgStr = serializer.serializeToString(svg);

            const canvas = document.createElement('canvas');
            canvas.width = 869;
            canvas.height = 1227;

            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                const pngFile = canvas.toDataURL('image/png');
                const downloadLink = document.createElement('a');
                downloadLink.download = 'mekuru_quartet_card.png';
                downloadLink.href = pngFile;
                downloadLink.click();
            }
            img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);
        });

        // Status Calculator functionality
        function validateInput(value, errorElement) {
            if (value === '') {
                errorElement.textContent = '値を入力してください';
                errorElement.style.display = 'block';
                return false;
            }
            if (!/^\d*\.?\d+$/.test(value) || parseFloat(value) < 0) {
                errorElement.textContent = '0以上の数値を入力してください';
                errorElement.style.display = 'block';
                return false;
            }
            errorElement.style.display = 'none';
            return true;
        }

        function calculateStats() {
            const inputs = {
                s: document.getElementById('input-s').value,
                h1: document.getElementById('input-h1').value,
                e: document.getElementById('input-e').value,
                r: document.getElementById('input-r').value,
                l: document.getElementById('input-l').value,
                h2: document.getElementById('input-h2').value
            };

            let isValid = true;
            Object.entries(inputs).forEach(([key, value]) => {
                const errorElement = document.getElementById(`error-${key}`);
                if (!validateInput(value, errorElement)) {
                    isValid = false;
                }
            });

            if (!isValid) {
                return;
            }

            const values = Object.values(inputs).map(v => parseFloat(v));
            const logValues = values.map(v => Math.log10(v + 1));
            const minValue = Math.min(...logValues);
            const normalizedValues = logValues.map(v => v - minValue);
            const sum = normalizedValues.reduce((a, b) => a + b, 0);
            const finalValues = normalizedValues.map(v => 
                Math.round((v * 114 / sum) + 1)
            );

            calculatedStats = {
                attack: finalValues[0],
                defense: finalValues[1],
                magic: finalValues[2],
                magdef: finalValues[3],
                add: finalValues[4],
                focus: finalValues[5]
            };

            const outputIds = ['attack', 'defense', 'magic', 'magdef', 'add', 'focus'];
            finalValues.forEach((value, index) => {
                const outputElement = document.getElementById(`output-${outputIds[index]}`);
                outputElement.textContent = value;
                outputElement.style.animation = 'none';
                outputElement.offsetHeight;
                outputElement.style.animation = 'fadeIn 0.5s ease';
            });

            updateRadarChart(finalValues);
            document.getElementById('applyButton').style.display = 'block';
        }

        function updateRadarChart(data) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if (radarChart) {
                radarChart.destroy();
            }

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['攻撃', '防御', '魔法', '魔防', '加算', '注目'],
                    datasets: [{
                        label: 'ステータス',
                        data: data,
                        backgroundColor: 'rgba(0, 192, 255, 0.2)',
                        borderColor: 'rgba(0, 192, 255, 1)',
                        pointBackgroundColor: 'rgba(255, 128, 255, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(255, 128, 255, 1)',
                        borderWidth: 3,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 40,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            min: 0,
                            max: 60,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 12
                                },
                                color: '#64748b'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#1e293b'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function applyToCardMaker() {
            if (!calculatedStats) return;
            
            document.getElementById('attack').value = calculatedStats.attack;
            document.getElementById('defense').value = calculatedStats.defense;
            document.getElementById('magic').value = calculatedStats.magic;
            document.getElementById('magicDef').value = calculatedStats.magdef;
            document.getElementById('addition').value = calculatedStats.add;
            document.getElementById('attention').value = calculatedStats.focus;
            
            switchTab('card-maker');
            updateCard();
            
            // Show success message
            const button = document.getElementById('applyButton');
            const originalText = button.textContent;
            button.textContent = '✅ 適用完了！';
            button.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
        }

        function openStatusCalculator() {
            switchTab('status-calc');
        }

        // Event listeners for card maker
        const form = document.getElementById('cardForm');
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('change', updateCard);
            input.addEventListener('input', updateCard);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCard();
            updateRadarChart([0, 0, 0, 0, 0, 0]);
            
            // Debug: プレビューエリアの確認
            console.log('cardPreview element:', document.getElementById('cardPreview'));
        });
    </script>
</body>
</html>